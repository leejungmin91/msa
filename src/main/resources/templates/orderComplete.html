<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/layout}">

<th:block layout:fragment="content">
    <section class="ftco-section">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-lg-12">
                    <div class="login-wrap p-4 p-md-5 bg-white">
                        <div class="order-status-summary d-flex justify-content-around align-items-center border rounded bg-white py-3 mb-4">
                            <div class="text-center">
                                <div style="font-weight: bold;">주문이 완료되었습니다.</div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12">
                            </div>
                        </div>
                        <div class="row invoice-info" style="margin-bottom: 50px;">
                            <div class="col-sm-4 invoice-col">
                                <b>주문자 정보</b><br>
                                주문자:<b id="order-name"></b><br>
                                <br>
                                배송지:<b id="address"></b>  <br>
                                휴대번호:<b id="phone-no"></b>  <br>
                                이메일:<b id="email"></b>
                            </div>
                            <div class="col-sm-4 invoice-col">
                                <b>결제수단</b><br>
                                <br>
                                결제수단:<b ></b><br>
                                결제사:<b id="fn-nm"></b><br>
                                승인번호:<b id="card-no"></b>
                            </div>
                            <div class="col-sm-4 invoice-col">
                                <b>뭐라할까</b><br>
                                주문번호<b id="order-no"> </b><br>
                                <br>
                                주문일시:<b id="order-date"></b><br>
                                총 금액:<b id="amt"></b>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12 table-responsive">
                                <table class="table table-striped" style="min-width: 100% !important;">
                                    <thead>
                                    <tr>
                                        <th>순번</th>
                                        <th>상품명</th>
                                        <th>수량</th>
                                        <th>금액</th>
                                    </tr>
                                    </thead>
                                    <tbody id="orderComList" >

                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
</th:block>

<th:block layout:fragment="scripts">
    <script>
        $(document).ready(() => {
            searchOrders();

            $('#periodSelect, #statusSelect').on('change', function () {
                searchOrders();
            });
        });

        function searchOrders() {
            const ordNo = "[[${ordNo}]]";
            GetAjax(`/order/complete/${ordNo}`, '', true).then((data) => {
                const orders = data.orderItems;

                if (!orders || orders.length === 0) {
                    $("#orderList").html(`<p class="text-center">주문 내역이 없습니다.</p>`);
                    return;
                }
                const orderDate = data.orderDate;
                const orderNo = data.orderNo;

                const labelMap = {
                    orderName: "주문자명",
                    orderPhone: "전화번호",
                    orderAddress: "주소",
                    orderAddressDetail: "상세주소",
                    orderZipCode: "우편번호",
                    orderDate: "주문일자",
                    amt : "결제금액",
                    email : "이메일",
                    fnNm : "카드사",
                    cardNo : "카드번호"
                };

                const orderer = [];
                const orderInfo = [];

                const detailInfo = data.orderDetailResponseDto;
                Object.entries(detailInfo).forEach(([key, value]) => {
                    if (value !== null && value !== undefined) {
                        orderer.push({
                            title: labelMap[key] || key,
                            value: value
                        });
                    }
                });


                const payInfo = data.orderPayResponseDto;
                Object.entries(payInfo).forEach(([key, value]) => {
                    if (value !== null && value !== undefined) {
                        orderInfo.push({
                            title: labelMap[key] || key,
                            value: value
                        });
                    }
                });
                const ordererMap = {};
                orderer.forEach(item => {
                    ordererMap[item.title] = item.value;
                });

                const orderInfoMap = {};
                orderInfo.forEach(item => {
                    orderInfoMap[item.title] = item.value;
                });

                $("#order-date").text(orderDate);
                $("#order-no").text(orderNo);
                $("#order-name").text(ordererMap["주문자명"]);
                $("#phone-no").text(ordererMap["전화번호"]);
                $("#amt").text(orderInfoMap["결제금액"]);
                $("#address").text(orderInfoMap["주소"] +orderInfoMap["상세주소"] + "(" + orderInfoMap["우편번호"] + ")") ;
                $("#email").text(orderInfoMap["이메일"]);
                $("#fn-nm").text(orderInfoMap["카드사"]);
                $("#card-no").text(orderInfoMap["카드번호"]);

                let html = '';
                orders.forEach((item, index) => {
                        html += `

                        <tr>
                            <td>${index + 1}</td>
                            <td>${item.productName}</td>
                            <td>${item.productQuantity}</td>
                            <td>${item.productPrice}</td>
                        </tr>
                        `;
                });
                $("#orderComList").html(html);
            }).catch((err) => {
                $("#orderList").html(`<p class="text-danger text-center">주문 정보를 불러오는 데 실패했습니다.</p>`);
            });
        }
    </script>
</th:block>

</html>
