<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/layout}">

<th:block layout:fragment="content">
    <section class="ftco-section">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-md-6 col-lg-6">
                    <div class="login-wrap p-4 p-md-5 bg-white" id="profileForm">
                        <h3 class="text-center mb-4">ë‚´ ì •ë³´ ìˆ˜ì •</h3>

                        <!-- ì´ë¦„ (ìˆ˜ì • ë¶ˆê°€) -->
                        <div class="mb-3 position-relative">
                            <label class="form-label fw-bold" style="color: #212529; font-weight: 600;">ì´ë¦„</label>
                            <input type="text" class="form-control not-editable" name="name" value="" readonly>
                            <span class="lock-icon">ğŸ”’</span>
                        </div>

                        <!-- ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ -->
                        <div class="mb-3">
                            <label for="password" id="passwordLabel" class="form-label fw-bold" style="color: #212529; font-weight: 600;">ë¹„ë°€ë²ˆí˜¸</label>
                            <input type="password" class="form-control mt-1" id="password" name="password" placeholder="ë¹„ë°€ë²ˆí˜¸" required>
                            <div id="passwordError" class="error-msg d-none"></div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold" id="passwordConfirmLabel" style="color: #212529; font-weight: 600;">ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
                            <input type="password" class="form-control mt-1" id="passwordConfirm" name="passwordConfirm" placeholder="ë¹„ë°€ë²ˆí˜¸ í™•ì¸" required>
                            <div id="passwordConfirmError" class="error-msg d-none"></div>
                        </div>

                        <!-- ì—°ë½ì²˜ -->
                        <div class="mb-3">
                            <label class="form-label fw-bold" style="color: #212529; font-weight: 600;">ì—°ë½ì²˜</label>
                            <input type="text" class="form-control" name="phone" placeholder="01012345678" value="">
                        </div>

                        <br>

                        <!-- ìˆ˜ì • ë²„íŠ¼ -->
                        <div class="form-group mt-4">
                            <button id="updateButton" type="submit" class="btn btn-primary btn-block" style="padding: 12px 0; font-size: 18px;">ì •ë³´ ìˆ˜ì •</button>
                        </div>
                        <div class="form-group mt-4">
                            <button id="openModalBtn" type="submit" class="btn btn-info btn-block" style="padding: 12px 0; font-size: 18px;">ë°°ì†¡ì§€ ê´€ë¦¬</button>
                        </div>

                        <div class="form-group text-center mt-2">
                            <a href="/" class="text-primary">í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <th:block th:replace="layout/fragments/shippingModal :: shippingModalLayout"></th:block>

</th:block>

<th:block layout:fragment="scripts">
    <script>
        let userNo;
        let isPwValid = true;

        $(document).ready(() => {
           GetAjax(`/member/@me`, null, true).then((data) => {
               userNo = data.id;
               $("input[name='name']").val(data.name);
               $("input[name='phone']").val(data.phone);
           });
        });

        $("#updateButton").on("click", () => {
            // ê°„ë‹¨í•œ ì˜ˆ: ë¹„ë°€ë²ˆí˜¸ í™•ì¸ ì¼ì¹˜ ì—¬ë¶€
            if(!isValid()) return;

            if(!confirm("ìˆ˜ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

            const data = {
                password: $("input[name='password']").val(),
                phone: $("input[name='phone']").val(),
            };

            PatchAjax(`/member/@me`, data, true).then((data) => {
               alert("ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
               location.reload();
            });
        });

        function isValid() {

            if(!isPwValid) {
                alert('ë¹„ë°€ë²ˆí˜¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.');
                return false;
            }

            if(!isValidPhoneNumber()) {
                alert('ì—°ë½ì²˜ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.');
                return false;
            }

            return true;
        }

        function isValidPhoneNumber() {
            // ìˆ«ìë§Œ 10ìë¦¬ ë˜ëŠ” 11ìë¦¬, ì•ìë¦¬ëŠ” 01ë¡œ ì‹œì‘
            const pattern = /^01[016789]\d{7,8}$/;
            return pattern.test($("input[name='phone']").val());
        }

        function isValidPassword(pw) {
            return pw.length >= 8 && /[a-zA-Z]/.test(pw) && /\d/.test(pw);
        }

        function isEmpty(value) {
            return value.trim() === '';
        }

        function showError(inputId, labelId, errorId, message) {
            $(`#${inputId}`).addClass('error');
            $(`#${labelId}`).addClass('label-error');
            $(`#${errorId}`).removeClass('d-none').text(message);
        }

        function clearError(inputId, labelId, errorId) {
            $(`#${inputId}`).removeClass('error');
            $(`#${labelId}`).removeClass('label-error');
            $(`#${errorId}`).addClass('d-none').text('');
        }

        // ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ ì‹œ ìœ íš¨ì„± ê²€ì‚¬
        $('#password').on('input', function () {
            const pw = $(this).val();
            if (!isValidPassword(pw)) {
                showError('password', 'passwordLabel', 'passwordError', 'ë¹„ë°€ë²ˆí˜¸ëŠ” ì˜ë¬¸, ìˆ«ìë¥¼ í¬í•¨í•˜ì—¬ 8ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
                isPwValid = false;
            } else {
                clearError('password', 'passwordLabel', 'passwordError');
                isPwValid = true;
            }

            // ë¹„ë°€ë²ˆí˜¸ í™•ì¸ê³¼ ì¼ì¹˜ ì—¬ë¶€ë„ í•¨ê»˜ ì²´í¬
            $('#passwordConfirm').trigger('input');
        });

        // ë¹„ë°€ë²ˆí˜¸ í™•ì¸ ì…ë ¥ ì‹œ ì¼ì¹˜ ì—¬ë¶€ ê²€ì‚¬
        $('#passwordConfirm').on('input', function () {
            const pw = $('#password').val();
            const confirmPw = $(this).val();

            if (pw !== confirmPw) {
                showError('passwordConfirm', 'passwordConfirmLabel', 'passwordConfirmError', 'ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                isPwValid = false;
            } else {
                clearError('passwordConfirm', 'passwordConfirmLabel', 'passwordConfirmError');
                isPwValid = true;
            }
        });
    </script>
</th:block>

</html>
