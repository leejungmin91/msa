<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/layout}">

<th:block layout:fragment="content">
    <section class="ftco-section">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-md-6 col-lg-6">
                    <div class="login-wrap p-4 p-md-5 bg-white" id="profileForm">
                        <h3 class="text-center mb-4">내 정보 수정</h3>

                        <!-- 이름 (수정 불가) -->
                        <div class="mb-3 position-relative">
                            <label class="form-label fw-bold" style="color: #212529; font-weight: 600;">이름</label>
                            <input type="text" class="form-control not-editable" name="name" value="" readonly>
                            <span class="lock-icon">🔒</span>
                        </div>

                        <!-- 비밀번호 입력 -->
                        <div class="mb-3">
                            <label for="password" id="passwordLabel" class="form-label fw-bold" style="color: #212529; font-weight: 600;">비밀번호</label>
                            <input type="password" class="form-control mt-1" id="password" name="password" placeholder="비밀번호" required>
                            <div id="passwordError" class="error-msg d-none"></div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold" id="passwordConfirmLabel" style="color: #212529; font-weight: 600;">비밀번호 확인</label>
                            <input type="password" class="form-control mt-1" id="passwordConfirm" name="passwordConfirm" placeholder="비밀번호 확인" required>
                            <div id="passwordConfirmError" class="error-msg d-none"></div>
                        </div>

                        <!-- 연락처 -->
                        <div class="mb-3">
                            <label class="form-label fw-bold" style="color: #212529; font-weight: 600;">연락처</label>
                            <input type="text" class="form-control" name="phone" placeholder="01012345678" value="">
                        </div>

                        <br>

                        <!-- 수정 버튼 -->
                        <div class="form-group mt-4">
                            <button id="updateButton" type="submit" class="btn btn-primary btn-block" style="padding: 12px 0; font-size: 18px;">정보 수정</button>
                        </div>
                        <div class="form-group mt-4">
                            <button id="openModalBtn" type="submit" class="btn btn-info btn-block" style="padding: 12px 0; font-size: 18px;">배송지 관리</button>
                        </div>

                        <div class="form-group text-center mt-2">
                            <a href="/" class="text-primary">홈으로 돌아가기</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <th:block th:replace="layout/fragments/shippingModal :: shippingModalLayout"></th:block>

</th:block>

<th:block layout:fragment="scripts">
    <script>
        let userNo;
        let isPwValid = true;

        $(document).ready(() => {
           GetAjax(`/member/@me`, null, true).then((data) => {
               userNo = data.id;
               $("input[name='name']").val(data.name);
               $("input[name='phone']").val(data.phone);
           });
        });

        $("#updateButton").on("click", () => {
            // 간단한 예: 비밀번호 확인 일치 여부
            if(!isValid()) return;

            if(!confirm("수정하시겠습니까?")) return;

            const data = {
                password: $("input[name='password']").val(),
                phone: $("input[name='phone']").val(),
            };

            PatchAjax(`/member/@me`, data, true).then((data) => {
               alert("수정되었습니다.");
               location.reload();
            });
        });

        function isValid() {

            if(!isPwValid) {
                alert('비밀번호를 확인해주세요.');
                return false;
            }

            if(!isValidPhoneNumber()) {
                alert('연락처를 확인해주세요.');
                return false;
            }

            return true;
        }

        function isValidPhoneNumber() {
            // 숫자만 10자리 또는 11자리, 앞자리는 01로 시작
            const pattern = /^01[016789]\d{7,8}$/;
            return pattern.test($("input[name='phone']").val());
        }

        function isValidPassword(pw) {
            return pw.length >= 8 && /[a-zA-Z]/.test(pw) && /\d/.test(pw);
        }

        function isEmpty(value) {
            return value.trim() === '';
        }

        function showError(inputId, labelId, errorId, message) {
            $(`#${inputId}`).addClass('error');
            $(`#${labelId}`).addClass('label-error');
            $(`#${errorId}`).removeClass('d-none').text(message);
        }

        function clearError(inputId, labelId, errorId) {
            $(`#${inputId}`).removeClass('error');
            $(`#${labelId}`).removeClass('label-error');
            $(`#${errorId}`).addClass('d-none').text('');
        }

        // 비밀번호 입력 시 유효성 검사
        $('#password').on('input', function () {
            const pw = $(this).val();
            if (!isValidPassword(pw)) {
                showError('password', 'passwordLabel', 'passwordError', '비밀번호는 영문, 숫자를 포함하여 8자 이상이어야 합니다.');
                isPwValid = false;
            } else {
                clearError('password', 'passwordLabel', 'passwordError');
                isPwValid = true;
            }

            // 비밀번호 확인과 일치 여부도 함께 체크
            $('#passwordConfirm').trigger('input');
        });

        // 비밀번호 확인 입력 시 일치 여부 검사
        $('#passwordConfirm').on('input', function () {
            const pw = $('#password').val();
            const confirmPw = $(this).val();

            if (pw !== confirmPw) {
                showError('passwordConfirm', 'passwordConfirmLabel', 'passwordConfirmError', '비밀번호가 일치하지 않습니다.');
                isPwValid = false;
            } else {
                clearError('passwordConfirm', 'passwordConfirmLabel', 'passwordConfirmError');
                isPwValid = true;
            }
        });
    </script>
</th:block>

</html>
