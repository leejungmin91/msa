<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/layout}">

<th:block layout:fragment="content">
    <section class="ftco-section">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-lg-12">
                    <div class="login-wrap p-4 p-md-5 bg-white">
                        <div class="order-status-summary d-flex justify-content-around align-items-center border rounded bg-white py-3 mb-4">
                            <!--<div class="text-center"><div class="fw-bold">ì…ê¸ˆëŒ€ê¸°</div><div class="text-primary">0</div></div>
                            <div>&gt;</div>-->
                            <div class="text-center"><div style="font-weight: bold;">ì£¼ë¬¸ì™„ë£Œ</div><div class="text-primary" id="statusOrder">0</div></div>
                            <div><!--<span class="flipped-truck">ğŸšš</span>-->â¡ï¸</div>
                            <!--<div class="text-center"><div>ë°°ì†¡ì¤€ë¹„</div><div class="text-primary">0</div></div>
                            <div>&gt;</div>-->
                            <div class="text-center"><div style="font-weight: bold;">ë°°ì†¡ì¤‘</div><div class="text-primary" id="statusDelivery">0</div></div>
                            <div><!--<span class="flipped-truck">ğŸšš</span>-->â¡ï¸</div>
                            <div class="text-center"><div style="font-weight: bold;">ë°°ì†¡ì™„ë£Œ</div><div class="text-primary" id="statusCompleted">0</div></div>
                            <!--<div>&gt;</div>
                            <div class="text-center"><div>êµ¬ë§¤í™•ì •</div><div class="text-primary">12</div></div>-->
                        </div>

                        <div class="d-flex justify-content-start order-select-header" style="gap:16px;">
                            <select class="custom-select" id="periodSelect" style="width: 120px;">
                                <option value="3m" selected>3ê°œì›” ì „</option>
                                <option value="6m">6ê°œì›” ì „</option>
                                <option value="1y">1ë…„ ì „</option>
                            </select>
                            <select class="custom-select" id="statusSelect" style="width: 120px;">
                                <option value="ALL" selected>ì „ì²´</option>
                                <option value="ORDER">ì£¼ë¬¸ì™„ë£Œ</option>
                                <option value="DELIVERY">ë°°ì†¡ì¤‘</option>
                                <option value="COMPLETE">ë°°ì†¡ì™„ë£Œ</option>
                                <option value="CANCEL">ì£¼ë¬¸ì·¨ì†Œ</option>
                            </select>
                        </div>

                        <div id="orderList">
                            <!-- ì£¼ë¬¸ë³„ ê·¸ë£¹ -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
</th:block>

<th:block layout:fragment="scripts">
    <script>
        $(document).ready(() => {
            searchOrders();

            $('#periodSelect, #statusSelect').on('change', function () {
                searchOrders();
            });
        });

        function searchOrders() {
            let period, status;
            period = $('#periodSelect').val();
            status = $('#statusSelect').val();
            const data = {"period" : period, "status" : status};

            PostAjax(`/order/@me`, data, true).then((data) => {

                const orders = data.orders;
                const status = data.statusCount;

                if (!orders || orders.length === 0) {
                    $("#orderList").html(`<p class="text-center">ì£¼ë¬¸ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>`);
                    return;
                }

                $("#statusOrder").text(status.ORDER);
                $("#statusDelivery").text(status.DELIVERY);
                $("#statusCompleted").text(status.COMPLETED);

                let html = '';

                let lastPrintedDate = null;

                orders.forEach(group => {
                    const orderItems = group.items;

                    // 1. orderNoë¡œ ê·¸ë£¹í•‘
                    const groupedByOrderNo = {};
                    orderItems.forEach(item => {
                        if (!groupedByOrderNo[item.orderNo]) {
                            groupedByOrderNo[item.orderNo] = [];
                        }
                        groupedByOrderNo[item.orderNo].push(item);
                    });

                    // 2. ì£¼ë¬¸ë²ˆí˜¸ë³„ë¡œ ë‚˜ëˆ ì„œ ì¶œë ¥
                    Object.keys(groupedByOrderNo).forEach(orderNo => {
                        const items = groupedByOrderNo[orderNo];
                        const firstItem = items[0];
                        const itemCount = items.length;
                        const totalAmount = items.reduce((sum, item) => sum + (item.productPrice * item.productQuantity), 0);
                        const orderDate = formatISODateTimeKST(firstItem.orderDate);

                        if (lastPrintedDate !== orderDate) {
                            html += `
                                <div class="order-date-header d-flex justify-content-between align-items-center">
                                    <div><strong>${orderDate}</strong></div>
                                </div>
                            `;
                            lastPrintedDate = orderDate;
                        }

                        html += `
                            <div class="order-group border bg-white p-4 mb-4 rounded">
                                <div class="order-item d-flex justify-content-between align-items-center">
                                    <img src="${firstItem.productMainImageUrl || 'https://via.placeholder.com/80'}" width="80" height="80" class="border rounded" alt="${firstItem.productMainFileName}">
                                    <div class="order-item-content">
                                        <div class="fw-bold large">
                                            <strong>${firstItem.productName}</strong>
                                            ${itemCount > 1 ? `<span class="text-muted small"> ì™¸ ${itemCount - 1}ê±´</span>` : ''}
                                        </div>
                                        <div class="text-muted small">${totalAmount.toLocaleString()}ì›</div>
                                        <div class="text-muted small">${firstItem.statusText}</div>
                                        <div class="text-muted small">ì£¼ë¬¸ì‹œê°„ : ${orderDate}</div>
                                    </div>
                                    <div>
                                        <button class="btn btn-dark btn-sm" onclick="goDetail('${orderNo}')">ìƒì„¸ë³´ê¸°</button>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                });

                $("#orderList").html(html);
            }).catch(() => {
                $("#orderList").html(`<p class="text-danger text-center">ì£¼ë¬¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>`);
            });
        }

        function goDetail(ordNo){
           location.href="/order/orderDetail?orderNo="+encodeURIComponent(ordNo);
        }

        function formatISODateTimeKST(isoString) {
            const [datePart, timePart] = isoString.split('T');
            const [year, month, day] = datePart.split('-').map(Number);
            const [hour, minute, second] = timePart.split(':').map(Number);

            const date = new Date(year, month - 1, day, hour, minute, second);
            const kst = new Date(date.getTime() + (9 * 60 * 60 * 1000)); 

            const pad = n => n.toString().padStart(2, '0');

            return `${kst.getFullYear()}ë…„ ${pad(kst.getMonth() + 1)}ì›” ${pad(kst.getDate())}ì¼ ${pad(kst.getHours())}ì‹œ ${pad(kst.getMinutes())}ë¶„ ${pad(kst.getSeconds())}ì´ˆ`;
        }


    </script>
</th:block>

</html>
