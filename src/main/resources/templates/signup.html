<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/layout}">

<th:block layout:fragment="content">

    <!-- 회원가입 폼 -->
    <section class="ftco-section">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-md-6 col-lg-6">
                    <div class="login-wrap p-4 p-md-5 bg-white">
                        <h3 class="text-center mb-4">회원가입</h3>

                        <!-- 회원가입 실패 메시지 -->
                        <div id="registerError" class="alert alert-danger text-center">
                            입력 정보를 확인해주세요.
                        </div>

                        <!-- 이메일 입력 및 인증 -->
                        <div class="mb-3">
                            <label for="emailId" class="form-label fw-bold" style="color: #212529; font-weight: 600;">이메일</label>
                            <div class="d-flex align-items-center gap-2">
                                <input type="text" class="form-control" id="emailId" name="emailId" placeholder="이메일" required>
                                <span class="mx-1">@</span>
                                <select class="form-control" id="emailDomainSelect" name="emailDomain" required>
                                    <option value="">선택해주세요</option>
                                    <option value="gmail.com">gmail.com</option>
                                    <option value="naver.com">naver.com</option>
                                    <option value="daum.net">daum.net</option>
                                    <option value="kakao.com">kakao.com</option>
                                    <option value="custom">직접입력</option>
                                </select>
                            </div>

                            <!-- 직접입력 입력창 -->
                            <input type="text" class="form-control mt-2 custom-domain-input" id="customDomainInput" placeholder="도메인 입력 (예: example.com)">
                        </div>
                        <!--<div class="mb-3">
                            <button id="emailVerifyButton" class="btn btn-secondary btn-block">이메일 인증하기</button>
                        </div>-->

                        <!-- 비밀번호 입력 -->
                        <div class="mb-3">
                            <label for="password" id="passwordLabel" class="form-label fw-bold" style="color: #212529; font-weight: 600;">비밀번호</label>
                            <input type="password" class="form-control mt-1" id="password" name="password" placeholder="비밀번호" required>
                            <div id="passwordError" class="error-msg d-none"></div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold" id="passwordConfirmLabel" style="color: #212529; font-weight: 600;">비밀번호 확인</label>
                            <input type="password" class="form-control mt-1" id="passwordConfirm" name="passwordConfirm" placeholder="비밀번호 확인" required>
                            <div id="passwordConfirmError" class="error-msg d-none"></div>
                        </div>

                        <!-- 이름 입력 -->
                        <div class="mb-3">
                            <label class="form-label fw-bold" style="color: #212529; font-weight: 600;">이름</label>
                            <input type="text" class="form-control" name="name" placeholder="" required>
                        </div>

                        <!-- 연락처 입력 -->
                        <div class="mb-3">
                            <label class="form-label fw-bold" style="color: #212529; font-weight: 600;">연락처</label>
                            <input type="text" class="form-control" name="phone" placeholder="" required>
                        </div>

                        <!-- 약관 동의 -->
                        <div class="mb-3">
                            <label class="form-label fw-bold" style="color: #212529; font-weight: 600;">약관 동의</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="agreeAll">
                                <label class="form-check-label" for="agreeAll">전체 동의 (필수사항 포함)</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="agreeAge">
                                <label class="form-check-label" for="agreeAge">만 14세 이상입니다 (필수)</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="agreeTerms">
                                <label class="form-check-label" for="agreeTerms">이용약관 동의 (필수)</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="agreePrivacy">
                                <label class="form-check-label" for="agreePrivacy">개인정보 수집 및 이용 동의 (필수)</label>
                            </div>
                            <!--<div class="form-check">
                                <input class="form-check-input" type="checkbox" id="agreeMarketing">
                                <label class="form-check-label" for="agreeMarketing">마케팅 활용 동의 (선택)</label>
                            </div>-->
                        </div>

                        <!-- reCAPTCHA -->
                        <div class="mb-3 text-center">
                            <div class="g-recaptcha" data-sitekey="YOUR_RECAPTCHA_SITE_KEY"></div>
                        </div>

                        <!-- 회원가입 버튼 -->
                        <div class="form-group">
                            <button id="registerButton" type="submit" class="btn btn-primary btn-block" style="padding: 12px 0; font-size: 18px;">회원가입하기</button>
                        </div>

                        <div class="form-group text-center">
                            <a href="/login" class="text-primary">이미 계정이 있으신가요? 로그인</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
</th:block>

<th:block layout:fragment="scripts">
    <script>
        let isPwValid = false;

        $(document).ready(() => {
            $("#registerError").hide();
            $('#customDomainInput').hide();

            $('#emailDomainSelect').on('change', function () {
                if ($(this).val() === 'custom') {
                    $('#customDomainInput').show();
                } else {
                    $('#customDomainInput').hide();
                }
            });

            $("#registerButton").on("click", async () => {

                if(!isValid()) return;

                const data = {
                    "email": $("input[name='emailId']").val() + '@' + $("[name='emailDomain']").val(),
                    "name": $("input[name='name']").val(),
                    "password": $("input[name='password']").val(),
                    "phone": $("input[name='phone']").val(),
                };

                PostAjax("/member/signup", data)
                    .then((data) => {
                        alert("회원가입이 완료되었습니다! 로그인해주세요.");
                        window.location.href = "/login";
                    })
                    .catch(() => {
                        $("#registerError").show();
                    })
                ;
            });
        });

        function isValid() {
            if(!isValidDomain()) {
                alert('이메일을 확인해주세요.');
                return false;
            }

            if(!isPwValid) {
                alert('비밀번호를 확인해주세요.');
                return false;
            }

            if(!isValidPhoneNumber()) {
                alert('연락처를 확인해주세요.');
                return false;
            }

            return true;
        }

        function isValidPhoneNumber() {
            // 숫자만 10자리 또는 11자리, 앞자리는 01로 시작
            const pattern = /^01[016789]\d{7,8}$/;
            return pattern.test($("input[name='phone']").val());
        }

        function isValidDomain() {
            const pattern = /^[0-9a-zA-Z]([-_.]?[0-9a-zA-Z])*\.[a-zA-Z]{2,3}$/i
            let domain = $("[name='emailDomain']").val();
            if(domain === 'custom') domain = $("#customDomainInput").val();
            console.log(domain);
            return pattern.test(domain);
        }

        function isValidPassword(pw) {
            return pw.length >= 8 && /[a-zA-Z]/.test(pw) && /\d/.test(pw);
        }

        function isEmpty(value) {
            return value.trim() === '';
        }

        function showError(inputId, labelId, errorId, message) {
            $(`#${inputId}`).addClass('error');
            $(`#${labelId}`).addClass('label-error');
            $(`#${errorId}`).removeClass('d-none').text(message);
        }

        function clearError(inputId, labelId, errorId) {
            $(`#${inputId}`).removeClass('error');
            $(`#${labelId}`).removeClass('label-error');
            $(`#${errorId}`).addClass('d-none').text('');
        }

        // 비밀번호 입력 시 유효성 검사
        $('#password').on('input', function () {
            const pw = $(this).val();
            if (!isValidPassword(pw)) {
                showError('password', 'passwordLabel', 'passwordError', '비밀번호는 영문, 숫자를 포함하여 8자 이상이어야 합니다.');
                isPwValid = false;
            } else {
                clearError('password', 'passwordLabel', 'passwordError');
                isPwValid = true;
            }

            // 비밀번호 확인과 일치 여부도 함께 체크
            $('#passwordConfirm').trigger('input');
        });

        // 비밀번호 확인 입력 시 일치 여부 검사
        $('#passwordConfirm').on('input', function () {
            const pw = $('#password').val();
            const confirmPw = $(this).val();

            if (pw !== confirmPw) {
                showError('passwordConfirm', 'passwordConfirmLabel', 'passwordConfirmError', '비밀번호가 일치하지 않습니다.');
                isPwValid = false;
            } else {
                clearError('passwordConfirm', 'passwordConfirmLabel', 'passwordConfirmError');
                isPwValid = true;
            }
        });
    </script>
</th:block>

</html>
